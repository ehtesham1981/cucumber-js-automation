var request = require('request-promise');

var BrowserstackService = function BrowserstackService () {};

BrowserstackService.prototype.before = function before () {
  this.sessionId = global.browser.sessionId;
  this.auth = global.browser.requestHandler.auth || {};
};

BrowserstackService.prototype.after = function after (failures) {
  this._update(this.sessionId, this._getBody(failures === 0));
};

BrowserstackService.prototype._update = function _update (sessionId, body) {
  request({
    method: 'PUT',
    uri: ("https://www.browserstack.com/automate/sessions/" + (this.sessionId) + ".json"),
    json: true,
    auth: this.auth,
    body: body
  });
};

BrowserstackService.prototype._getBody = function _getBody (success) {
  return {
    status: success ? 'completed' : 'error'
  };
};

module.exports = BrowserstackService;
